
/* 
 * The Gradle task dependencies 
 */
buildscript {
	repositories {
	  mavenLocal()
    mavenCentral()
	}
	dependencies {
		classpath 'io.opencaesar.adapters:oml2owl-gradle:+'
    classpath 'io.opencaesar.oml:oml-merge-gradle:+'
		classpath 'io.opencaesar.owl:owl-load-gradle:+'
		classpath 'io.opencaesar.owl:owl-reason-gradle:+'
		classpath 'io.opencaesar.owl:owl-fuseki:+'
		classpath 'io.opencaesar.owl:owl-fuseki-gradle:+'
		classpath 'io.opencaesar.owl:owl-query-gradle:+'
		classpath 'io.opencaesar.oml:oml-bikeshed-gradle:+'
	}
}

plugins {
  id 'com.palantir.git-version' version '0.12.3'
}

ext.title="Metrology Vocabularies"
description='Metrology from iupac.org, iso/iec 80000 and NIST Special publication 811'
group='io.opencaesar.ontologies'
version gitVersion()

def fusekiDataset = 'metrology-vocabularies' 

apply from: "${rootDir}/gradle/maven-deployment.gradle"

/*
 * Dependency versions
 */
ext.coreVersion = '3.+'

/*
 * The configuration of OML dependencies
 */
configurations {
	oml
}

/*
 * The repositories to look up OML dependencies in
 */
repositories {
	mavenLocal()
  mavenCentral()
}

/*
 * The OML dependencies
 */
dependencies {
	oml "io.opencaesar.ontologies:core-vocabularies:$coreVersion@zip"
}

/*
 * A task to extract and merge the OML dependencies
 */
task downloadDependencies(type:io.opencaesar.oml.merge.OmlMergeTask) {
    inputZipPaths = configurations.oml.files
    outputCatalogFolder = file('build/oml')
}

/*
 * A task to convert the OML catalog to OWL catalog
 */
task omlToOwl(type:io.opencaesar.oml2owl.Oml2OwlTask, dependsOn: downloadDependencies) {
  // OML catalog
  inputCatalogPath = file('catalog.xml')
  // OWL catalog
  outputCatalogPath = file('build/rdf/catalog.xml')
  outputFileExtension = 'rdf'
}

/*
 * A task to run the Openllet reasoner on the OWL catalog
 */
task owlReasonMetrology(type:io.opencaesar.owl.reason.OwlReasonTask, dependsOn: omlToOwl) {
	// OWL catalog
	catalogPath = file('build/rdf/catalog.xml')
	// Input ontology IRI to reason on
	inputOntologyIri = 'http://iupac.org/metrology-bundle'
  inputFileExtensions = ['rdf']
	outputFileExtension = 'rdf'
	// Entailment statements to generate and the ontologies to persist them in
	specs = [
		'http://iupac.org/metrology-bundle/classes = ALL_SUBCLASS',
		'http://iupac.org/metrology-bundle/properties = INVERSE_PROPERTY | ALL_SUBPROPERTY',
		'http://iupac.org/metrology-bundle/individuals = ALL_INSTANCE | DATA_PROPERTY_VALUE | OBJECT_PROPERTY_VALUE | SAME_AS'
	]
	// Junit error report
	reportPath = file('build/reports/metrology-bundle/reasoning.xml')
}

task owlReasonISO80000(type:io.opencaesar.owl.reason.OwlReasonTask, dependsOn: omlToOwl) {
	// OWL catalog
	catalogPath = file('build/rdf/catalog.xml')
	// Input ontology IRI to reason on
	inputOntologyIri = 'http://iso.org/80000-bundle'
  inputFileExtensions = ['rdf']
	outputFileExtension = 'rdf'
	// Entailment statements to generate and the ontologies to persist them in
	specs = [
		'http://iso.org/80000-bundle/classes = ALL_SUBCLASS',
		'http://iso.org/80000-bundle/properties = INVERSE_PROPERTY | ALL_SUBPROPERTY',
		'http://iso.org/80000-bundle/individuals = ALL_INSTANCE | DATA_PROPERTY_VALUE | OBJECT_PROPERTY_VALUE | SAME_AS'
	]
	// Junit error report
	reportPath = file('build/reports/80000-bundle/reasoning.xml')
}

task owlReasonNistSP811(type:io.opencaesar.owl.reason.OwlReasonTask, dependsOn: omlToOwl) {
	// OWL catalog
	catalogPath = file('build/rdf/catalog.xml')
	// Input ontology IRI to reason on
	inputOntologyIri = 'http://nist.gov/pml/special-publication-811-bundle'
  inputFileExtensions = ['rdf']
	outputFileExtension = 'rdf'
	// Entailment statements to generate and the ontologies to persist them in
	specs = [
		'http://nist.gov/pml/special-publication-811-bundle/classes = ALL_SUBCLASS',
		'http://nist.gov/pml/special-publication-811-bundle/properties = INVERSE_PROPERTY | ALL_SUBPROPERTY',
		'http://nist.gov/pml/special-publication-811-bundle/individuals = ALL_INSTANCE | DATA_PROPERTY_VALUE | OBJECT_PROPERTY_VALUE | SAME_AS'
	]
	// Junit error report
	reportPath = file('build/reports/special-publication-811-bundle/reasoning.xml')
}

/*
 * A task to load an OWL catalog to a Fuseki dataset endpoint
 */
task owlLoad(type:io.opencaesar.owl.load.OwlLoadTask, dependsOn: [owlReasonMetrology, owlReasonISO80000, owlReasonNistSP811]) {
	catalogPath = file('build/rdf/catalog.xml')
	endpointURL = "http://localhost:3030/$fusekiDataset"
  fileExtensions = ['rdf']
	iris = [
		'http://iupac.org/metrology-bundle/classes',
		'http://iupac.org/metrology-bundle/properties',
		'http://iupac.org/metrology-bundle/individuals',
		'http://iso.org/80000-bundle/classes',
		'http://iso.org/80000-bundle/properties',
		'http://iso.org/80000-bundle/individuals',
		'http://nist.gov/pml/special-publication-811-bundle/classes',
	  'http://nist.gov/pml/special-publication-811-bundle/properties',
	  'http://nist.gov/pml/special-publication-811-bundle/individuals'
	]
}

/*
 * Start and stop the Fuseki server
 */
task startFuseki(type: io.opencaesar.owl.fuseki.StartFusekiTask, group: 'fuseki') {
	configurationPath = file('.fuseki.ttl')
	outputFolderPath = file('.fuseki')
}

task stopFuseki(type: io.opencaesar.owl.fuseki.StopFusekiTask, group: 'fuseki') {
	outputFolderPath = file('.fuseki')
}

/*
 * A task to generate Bikeshed specification for the OML catalog
 */
task omlToBikeshed(type: io.opencaesar.oml.bikeshed.Oml2BikeshedTask) {
  // OML catalog
  inputCatalogPath = file('catalog.xml')
  // OWL folder
  outputFolderPath = file('build/bikeshed')
  // Publish URL
  publishUrl = 'https://opencaesar.github.io/metrology-vocabularies/'
}

/*
 * A task to generate the Bikeshed documentations in HTML
 */
import org.gradle.internal.os.OperatingSystem
task generateDocs(dependsOn: omlToBikeshed) {
  doLast {
    if (OperatingSystem.current().isWindows()) {
        exec { commandLine 'build/bikeshed/publish.bat' }
    } else {
        exec { commandLine 'chmod', '+x', 'build/bikeshed/publish.sh' }
        exec { commandLine 'build/bikeshed/publish.sh' }
    }
  }
}

/*
 * A task to build the project, which executes several tasks together
 */
tasks.named('build') {
  dependsOn owlReasonMetrology
  dependsOn owlReasonISO80000
  dependsOn owlReasonNistSP811
}

/*
 * A task to delete the build artifacts
 */
tasks.named('build') {
	delete 'build'
}

/*
 * Publish to Maven spec
 */
apply plugin: 'maven-publish'

task omlZip(type: Zip, dependsOn: build, group: 'publishing') {
	from file('src/oml')
	include "**/*.oml"
	destinationDirectory = file('build/libs')
	archiveBaseName = project.name
	archiveVersion = project.version
	archiveExtension = 'zip'
}

publishing.publications.maven.artifact omlZip
